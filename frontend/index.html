<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Page Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        @font-face {
            font-family: 'Code';
            src: local('Courier New'), local('Monaco'), local('Consolas'), monospace;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="connect-screen" class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
        <div class="max-w-md w-full bg-white rounded-xl shadow-lg border border-gray-200 p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Connect to Your Site</h1>
                <p class="text-gray-600 text-base">Enter your SleekCMS pub token to get started</p>
            </div>
            
            <form id="connect-form" class="space-y-6">
                <div>
                    <label for="pub-token" class="block text-sm font-medium text-gray-700 mb-2">
                        Pub Token
                    </label>
                    <input
                        type="text"
                        id="pub-token"
                        name="pubToken"
                        placeholder="pub-1ez9p-xyz123"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm"
                        required
                    />
                    <p class="mt-2 text-xs text-gray-500">You can find your pub token in your SleekCMS dashboard</p>
                </div>
                
                <button
                    type="submit"
                    id="connect-button"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                >
                    <span id="connect-button-text">Connect</span>
                    <span id="connect-button-loader" class="hidden inline-flex items-center">
                        <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Connecting...
                    </span>
                </button>
            </form>
            
            <div id="connect-error" class="mt-4 hidden">
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="error-message"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden min-h-screen">
        <header id="main-header" class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="site-title" class="text-2xl font-bold"></h1>
                        <p id="site-subtitle" class="text-sm text-gray-500 mt-1">What would you like to explore?</p>
                    </div>
                    <div class="flex gap-2">
                        <button
                            id="back-to-home"
                            onclick="window.location.hash = ''"
                            class="hidden md:block px-4 py-2 rounded-lg transition"
                        >
                            ← Back to Home
                        </button>
                        <button
                            id="disconnect-button"
                            onclick="window.disconnectSession()"
                            class="px-4 py-2 rounded-lg transition border text-sm font-semibold"
                            style="color: var(--theme-primary, #3b82f6); border-color: var(--theme-primary, #3b82f6)30;"
                        >
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="homepage-content">
                <div id="action-buttons" class="mb-8 flex flex-wrap gap-4"></div>

                <div id="intent-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>

    <script>
        // Global state
        let sessionId = localStorage.getItem('sessionId') || null;
        let siteName = '';
        let intents = [];
        let themeColors = {};
        let heroData = {};
        let isGenerating = false;
        
        // Check for existing session on page load
        async function checkExistingSession() {
            const storedSessionId = localStorage.getItem('sessionId');
            if (!storedSessionId) {
                document.getElementById('connect-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                return;
            }
            
            try {
                // Check if session is still valid
                const response = await fetch(`http://localhost:3000/api/session/${storedSessionId}`);
                
                if (!response.ok) {
                    // Session not found or invalid, clear and show connect screen
                    localStorage.removeItem('sessionId');
                    sessionId = null;
                    document.getElementById('connect-screen').classList.remove('hidden');
                    document.getElementById('app-screen').classList.add('hidden');
                    return;
                }
                
                const data = await response.json();
                
                sessionId = data.sessionId;
                siteName = data.siteName;
                intents = data.intents;
                themeColors = data.themeColors || {};
                heroData = data.heroData || {};
                
                applyThemeColors(themeColors);
                
                document.getElementById('connect-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                const hash = window.location.hash.replace('#', '');
                if (hash) {
                } else {
                    renderHomepage();
                }
            } catch (error) {
                console.error('Session check error:', error);
                // On error, clear session and show connect screen
                localStorage.removeItem('sessionId');
                sessionId = null;
                document.getElementById('connect-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }
        
        function applyThemeColors(colors) {
            if (!colors || Object.keys(colors).length === 0) return;
            
            const primary = colors.primary || '#3b82f6';
            const secondary = colors.secondary || '#8b5cf6';
            const accent = colors.accent || '#f59e0b';
            const background = colors.background || '#ffffff';
            const text = colors.text || '#1f2937';
            
            // Apply to header
            const header = document.getElementById('main-header');
            const siteTitle = document.getElementById('site-title');
            const backButton = document.getElementById('back-to-home');
            
            if (header) {
                header.style.backgroundColor = background;
                header.style.borderColor = primary + '20';
            }
            if (siteTitle) {
                siteTitle.style.color = primary;
            }
            if (backButton) {
                backButton.style.color = primary;
                backButton.style.borderColor = primary + '30';
                backButton.onmouseenter = () => {
                    backButton.style.backgroundColor = primary + '10';
                };
                backButton.onmouseleave = () => {
                    backButton.style.backgroundColor = 'transparent';
                };
            }
            
            document.documentElement.style.setProperty('--theme-primary', primary);
            document.documentElement.style.setProperty('--theme-secondary', secondary);
            document.documentElement.style.setProperty('--theme-accent', accent);
            document.documentElement.style.setProperty('--theme-background', background);
            document.documentElement.style.setProperty('--theme-text', text);
            
            const style = document.createElement('style');
            style.textContent = `
                ::-webkit-scrollbar-thumb {
                    background: ${primary} !important;
                }
                ::-webkit-scrollbar-thumb:hover {
                    background: ${secondary} !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Connect form handler
        document.getElementById('connect-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pubToken = document.getElementById('pub-token').value.trim();
            const errorDiv = document.getElementById('connect-error');
            const errorMessage = document.getElementById('error-message');
            const connectButton = document.getElementById('connect-button');
            const connectButtonText = document.getElementById('connect-button-text');
            const connectButtonLoader = document.getElementById('connect-button-loader');
            
            errorDiv.classList.add('hidden');
            
            connectButton.disabled = true;
            connectButtonText.classList.add('hidden');
            connectButtonLoader.classList.remove('hidden');
            
            try {
                const response = await fetch('http://localhost:3000/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pubToken })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Connection failed');
                }
                
                const data = await response.json();
                
                sessionId = data.sessionId;
                siteName = data.siteName;
                intents = data.intents;
                themeColors = data.themeColors || {};
                heroData = data.heroData || {};
                
                localStorage.setItem('sessionId', sessionId);
                
                applyThemeColors(themeColors);
                
                document.getElementById('connect-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                renderHomepage();
            } catch (error) {
                errorMessage.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                connectButton.disabled = false;
                connectButtonText.classList.remove('hidden');
                connectButtonLoader.classList.add('hidden');
            }
        });

        async function renderHomepage() {
            const backButton = document.getElementById('back-to-home');
            if (backButton) backButton.classList.add('hidden');
            
            if (!sessionId || !intents || intents.length === 0) {
                document.getElementById('main-content').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-600">No intents available. Please connect with a pub token.</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('site-title').textContent = siteName;
            
            const primaryColor = themeColors.primary || '#3b82f6';
            const primaryLight = hexToRgba(primaryColor, 0.05);
            
            let heroHTML = '';
            if (heroData.title || heroData.subtitle || heroData.image) {
                heroHTML = `
                    <section class="hero-section mb-12 py-16 px-4 rounded-2xl" style="background: linear-gradient(135deg, ${primaryLight}, transparent);">
                        <div class="max-w-4xl mx-auto text-center">
                            ${heroData.image ? `
                                <div class="mb-8">
                                    <img src="${heroData.image}" alt="${heroData.title || 'Logo'}" class="mx-auto h-24 w-auto object-contain rounded-lg shadow-lg">
                                </div>
                            ` : ''}
                            <h1 class="text-5xl md:text-6xl font-bold mb-4" style="color: ${primaryColor};">
                                ${heroData.title || siteName}
                            </h1>
                            ${heroData.subtitle ? `
                                <p class="text-xl md:text-2xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
                                    ${heroData.subtitle}
                                </p>
                            ` : ''}
                        </div>
                    </section>
                `;
            }
            
            document.getElementById('main-content').innerHTML = `
                <div id="homepage-content">
                    ${heroHTML}
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Explore</h2>
                        <p class="text-gray-600">Choose what you'd like to discover</p>
                    </div>
                    <div id="intent-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            `;
            
            const cardsContainer = document.getElementById('intent-cards');
            cardsContainer.innerHTML = '';
            
            // Check status for all intents
            const statusChecks = await Promise.all(
                intents.map(async (intent) => {
                    try {
                        const response = await fetch(`http://localhost:3000/api/page-status/${intent.id}`);
                        const data = await response.json();
                        return { intent, generated: data.generated };
                    } catch {
                        return { intent, generated: false };
                    }
                })
            );
            
            const primaryLighter = hexToRgba(primaryColor, 0.2);
            const secondaryColor = themeColors.secondary || themeColors.accent || primaryColor;
            
            statusChecks.forEach(({ intent, generated }) => {
                const card = document.createElement('div');
                card.id = `intent-card-${intent.id}`;
                card.className = 'bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 flex flex-col';
                card.style.borderColor = `rgba(${hexToRgb(primaryColor)}, 0.2)`;
                
                // Professional icon display
                const iconDisplay = getProfessionalIcon(intent.icon, intent.title);
                
                let actionHTML = '';
                if (generated) {
                    actionHTML = `
                        <div class="flex gap-2">
                            <a href="#${intent.id}" class="flex-1 inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                View Page →
                            </a>
                            <button onclick="regeneratePageFromHome('${intent.id}', '${intent.dataPath.replace(/'/g, "\\'")}')" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${secondaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" title="Regenerate">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    actionHTML = `
                        <button onclick="generatePageFromHome('${intent.id}', '${intent.dataPath.replace(/'/g, "\\'")}')" class="w-full inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            Generate Page →
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center justify-center w-16 h-16 rounded-lg text-3xl" style="background: linear-gradient(to bottom right, ${primaryLight}, ${primaryLighter});">
                                ${iconDisplay}
                            </div>
                            ${generated ? '<div class="text-green-600"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>' : ''}
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${intent.title}</h3>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${intent.description}</p>
                        <div id="action-${intent.id}" class="intent-action mt-auto">
                            ${actionHTML}
                        </div>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
        }
        
        // Get professional icon display
        function getProfessionalIcon(icon, title) {
            // If it's already an emoji, wrap it nicely
            if (icon.match(/[\u{1F300}-\u{1F9FF}]/u)) {
                return `<span class="text-3xl">${icon}</span>`;
            }
            // Otherwise return as-is
            return icon;
        }
        
        // Helper to convert hex to rgba
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }
        
        async function generatePageFromHome(intentId, dataPath) {
            if (isGenerating) {
                return;
            }
            
            isGenerating = true;
            
            // Disable all intent cards
            disableAllIntentCards();
            
            const actionDiv = document.getElementById(`action-${intentId}`);
            const statusDiv = document.getElementById(`status-${intentId}`);
            if (!actionDiv) {
                isGenerating = false;
                enableAllIntentCards();
                return;
            }
            
            const intent = intents.find(i => i.id === intentId);
            if (!intent) {
                isGenerating = false;
                enableAllIntentCards();
                return;
            }
            
            const primaryColor = themeColors.primary || '#3b82f6';
            const primaryLight = hexToRgba(primaryColor, 0.1);
            
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-2" style="color: ${primaryColor};">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                `;
            }
            
            actionDiv.innerHTML = `
                <div class="flex items-center justify-center px-4 py-2 rounded-lg" style="background-color: ${primaryLight}; color: ${primaryColor};">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:3000/api/generate-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        intentId,
                        dataPath
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Generation failed');
                }
                
                const data = await response.json();
                
                // Update button to show view + regenerate
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="text-green-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    `;
                }
                
                const primaryColor = themeColors.primary || '#3b82f6';
                const secondaryColor = themeColors.secondary || themeColors.accent || primaryColor;
                actionDiv.innerHTML = `
                    <div class="flex gap-2">
                        <a href="#${intentId}" class="flex-1 inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            View Page →
                        </a>
                        <button onclick="regeneratePageFromHome('${intentId}', '${dataPath.replace(/'/g, "\\'")}')" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${secondaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" title="Regenerate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                `;
            } catch (error) {
                actionDiv.innerHTML = `
                    <div class="text-red-600 text-sm p-2">
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                isGenerating = false;
                enableAllIntentCards();
            }
        }
        
        function disableAllIntentCards() {
            intents.forEach(intent => {
                const card = document.getElementById(`intent-card-${intent.id}`);
                const pageCard = document.getElementById(`page-intent-card-${intent.id}`);
                
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                    card.style.cursor = 'not-allowed';
                }
                if (pageCard) {
                    pageCard.style.opacity = '0.5';
                    pageCard.style.pointerEvents = 'none';
                    pageCard.style.cursor = 'not-allowed';
                }
            });
        }
        
        function enableAllIntentCards() {
            intents.forEach(intent => {
                const card = document.getElementById(`intent-card-${intent.id}`);
                const pageCard = document.getElementById(`page-intent-card-${intent.id}`);
                
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = '';
                    card.style.cursor = '';
                }
                if (pageCard) {
                    pageCard.style.opacity = '1';
                    pageCard.style.pointerEvents = '';
                    pageCard.style.cursor = '';
                }
            });
        }
        
        async function regeneratePageFromHome(intentId, dataPath) {
            const actionDiv = document.getElementById(`action-${intentId}`);
            if (!actionDiv) return;
            
            const originalHTML = actionDiv.innerHTML;
            actionDiv.innerHTML = `
                <div class="flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Regenerating...
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:3000/api/regenerate-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        intentId,
                        dataPath
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Regeneration failed');
                }
                
                const data = await response.json();
                
                // Reload the current page if we're viewing it
                const currentHash = window.location.hash.replace('#', '');
                if (currentHash === intentId) {
                    window.location.hash = '';
                    setTimeout(() => {
                        window.location.hash = `#${intentId}`;
                    }, 100);
                }
                
                // Restore button
                actionDiv.innerHTML = originalHTML;
            } catch (error) {
                actionDiv.innerHTML = `
                    <div class="text-red-600 text-sm p-2">
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        function createIntentCardsSection() {
            if (!intents || intents.length === 0) return '';
            
            let cardsHTML = `
                <div class="mt-16 pt-8 border-t border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Explore More</h2>
                    <div id="page-intent-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            `;
            
            return cardsHTML;
        }
        
        async function attachIntentCardListeners() {
            const cardsContainer = document.getElementById('page-intent-cards');
            if (!cardsContainer) return;
            
            cardsContainer.innerHTML = '';
            
            // Check status for all intents
            const statusChecks = await Promise.all(
                intents.map(async (intent) => {
                    try {
                        const response = await fetch(`http://localhost:3000/api/page-status/${intent.id}`);
                        const data = await response.json();
                        return { intent, generated: data.generated };
                    } catch {
                        return { intent, generated: false };
                    }
                })
            );
            
            const primaryColor = themeColors.primary || '#3b82f6';
            const primaryLight = hexToRgba(primaryColor, 0.1);
            const primaryLighter = hexToRgba(primaryColor, 0.2);
            
            statusChecks.forEach(({ intent, generated }) => {
                const card = document.createElement('div');
                card.id = `page-intent-card-${intent.id}`;
                card.className = 'bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 flex flex-col';
                card.style.borderColor = `rgba(${hexToRgb(primaryColor)}, 0.2)`;
                
                // Professional icon display
                const iconDisplay = getProfessionalIcon(intent.icon, intent.title);
                
                let actionHTML = '';
                if (generated) {
                    actionHTML = `
                        <div class="flex gap-2">
                            <a href="#${intent.id}" class="flex-1 inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                View Page →
                            </a>
                            <button onclick="regeneratePage('${intent.id}', '${intent.dataPath.replace(/'/g, "\\'")}')" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${themeColors.secondary || themeColors.accent || primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" title="Regenerate">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    actionHTML = `
                        <button onclick="generatePageFromExplore('${intent.id}', '${intent.dataPath.replace(/'/g, "\\'")}')" class="w-full inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            Generate Page →
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center justify-center w-16 h-16 rounded-lg text-3xl" style="background: linear-gradient(to bottom right, ${primaryLight}, ${primaryLighter});">
                                ${iconDisplay}
                            </div>
                            ${generated ? '<div class="text-green-600"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>' : ''}
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${intent.title}</h3>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${intent.description}</p>
                        <div id="page-action-${intent.id}" class="intent-action mt-auto">
                            ${actionHTML}
                        </div>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
        }
        
        async function generatePageFromExplore(intentId, dataPath) {
            if (isGenerating) {
                return;
            }
            
            isGenerating = true;
            
            // Disable all intent cards
            disableAllIntentCards();
            
            const actionDiv = document.getElementById(`page-action-${intentId}`);
            if (!actionDiv) {
                isGenerating = false;
                enableAllIntentCards();
                return;
            }
            
            const primaryColor = themeColors.primary || '#3b82f6';
            const primaryLight = hexToRgba(primaryColor, 0.1);
            
            actionDiv.innerHTML = `
                <div class="flex items-center justify-center px-4 py-2 rounded-lg" style="background-color: ${primaryLight}; color: ${primaryColor};">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:3000/api/generate-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        intentId,
                        dataPath
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Generation failed');
                }
                
                const data = await response.json();
                
                const primaryColor = themeColors.primary || '#3b82f6';
                const secondaryColor = themeColors.secondary || themeColors.accent || primaryColor;
                actionDiv.innerHTML = `
                    <div class="flex gap-2">
                        <a href="#${intentId}" class="flex-1 inline-flex items-center justify-center px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${primaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            View Page →
                        </a>
                        <button onclick="regeneratePage('${intentId}', '${dataPath.replace(/'/g, "\\'")}')" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105" style="background-color: ${secondaryColor};" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" title="Regenerate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                `;
            } catch (error) {
                actionDiv.innerHTML = `
                    <div class="text-red-600 text-sm p-2">
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                isGenerating = false;
                enableAllIntentCards();
            }
        }
        
        async function regeneratePage(intentId, dataPath) {
            const actionDiv = document.getElementById(`page-action-${intentId}`);
            if (!actionDiv) return;
            
            const originalHTML = actionDiv.innerHTML;
            actionDiv.innerHTML = `
                <div class="flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Regenerating...
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:3000/api/regenerate-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        intentId,
                        dataPath
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Regeneration failed');
                }
                
                const data = await response.json();
                
                // Reload the current page if we're viewing it
                const currentHash = window.location.hash.replace('#', '');
                if (currentHash === intentId) {
                    window.location.hash = '';
                    setTimeout(() => {
                        window.location.hash = `#${intentId}`;
                    }, 100);
                }
                
                // Restore button
                actionDiv.innerHTML = originalHTML;
            } catch (error) {
                actionDiv.innerHTML = `
                    <div class="text-red-600 text-sm p-2">
                        Error: ${error.message}
                    </div>
                `;
            }
        }
        
        function removeExternalNavigation() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            
            const allLinks = mainContent.querySelectorAll('a[href]');
            allLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('#')) {
                    const text = link.textContent;
                    const span = document.createElement('span');
                    span.className = link.className;
                    span.textContent = text;
                    link.parentNode?.replaceChild(span, link);
                }
            });
            
            const buttons = mainContent.querySelectorAll('button[onclick]');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                if (onclick && (onclick.includes('location') || onclick.includes('window') || onclick.includes('href'))) {
                    button.remove();
                }
            });
            
            // Remove any form submissions
            const forms = mainContent.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                });
            });
        }

        window.disconnectSession = async function disconnectSession() {
            if (!sessionId) {
                // Already disconnected, just show connect screen
                document.getElementById('connect-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                return;
            }
            
            if (!confirm('Are you sure you want to disconnect? This will clear all generated pages and return to the connect screen.')) {
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Failed to disconnect');
                }
            } catch (error) {
                console.error('Disconnect error:', error);
                alert('Error disconnecting: ' + (error.message || 'Unknown error'));
            }
            
            sessionId = null;
            siteName = '';
            intents = [];
            themeColors = {};
            heroData = {};
            isGenerating = false;
            
            localStorage.removeItem('sessionId');
            
            window.location.hash = '';
            document.getElementById('connect-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            
            document.getElementById('pub-token').value = '';
        };
        
        async function handleHashChange() {
            const hash = window.location.hash.replace('#', '');
            const mainContent = document.getElementById('main-content');
            const backButton = document.getElementById('back-to-home');
            const disconnectButton = document.getElementById('disconnect-button');
            
            if (!hash) {
                if (sessionId && intents && intents.length > 0) {
                    renderHomepage();
                    backButton.classList.add('hidden');
                    if (disconnectButton) disconnectButton.classList.remove('hidden');
                } else {
                    document.getElementById('connect-screen').classList.remove('hidden');
                    document.getElementById('app-screen').classList.add('hidden');
                }
                return;
            }
            
            // Show back button and disconnect button when viewing a page
            backButton.classList.remove('hidden');
            if (disconnectButton) disconnectButton.classList.remove('hidden');
            
            // Check if this is a detail page FIRST
            const isDetailPage = hash.includes('-detail-');
            let parentIntentId = null;
            
            if (isDetailPage) {
                const parts = hash.split('-detail-');
                if (parts.length === 2) {
                    parentIntentId = parts[0];
                }
            }
            
            if (isDetailPage && parentIntentId) {
                backButton.setAttribute('onclick', `window.location.hash = '${parentIntentId}'`);
                backButton.innerHTML = '← Back';
            } else {
                // For regular pages, back button goes to home
                backButton.setAttribute('onclick', "window.location.hash = ''");
                backButton.innerHTML = '← Back to Home';
            }
            
            try {
                const response = await fetch(`http://localhost:3000/api/page/${hash}`);
                
                if (!response.ok) {
                    if (isDetailPage && parentIntentId) {
                        const parts = hash.split('-detail-');
                        if (parts.length === 2) {
                            const itemId = parts[1];
                            if (!mainContent.innerHTML.includes('Generating detail page')) {
                                showDetailPageLoader(hash, parentIntentId);
                            }
                            await generateDetailPageFromLink(parentIntentId, itemId);
                            return;
                        }
                    }
                    
                    if (!isDetailPage) {
                        const isValidIntent = intents && intents.some((intent) => intent.id === hash);
                        if (isValidIntent) {
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                            } catch {
                                throw new Error(errorText || `Server error: ${response.status}`);
                            }
                            throw new Error(errorData.error || 'Page not found. Please regenerate the page.');
                        }
                    }
                    
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Page not found');
                }
                
                const data = await response.json();
                
                // Inject HTML into main content
                mainContent.innerHTML = data.html;
                
                // Store parent intent ID for back navigation on detail pages
                if (isDetailPage && parentIntentId) {
                    mainContent.setAttribute('data-parent-intent', parentIntentId);
                }
                
                if (!isDetailPage) {
                    const intentCardsSection = createIntentCardsSection();
                    mainContent.insertAdjacentHTML('beforeend', intentCardsSection);
                    
                    // Re-attach event listeners for intent cards
                    attachIntentCardListeners();
                }
                
                // Attach detail page handlers if needed
                attachDetailPageHandlers();
                
                // Add click handler for back links
                const backLinks = mainContent.querySelectorAll('a[href^="#"]');
                backLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (href === '#') {
                            // Back to home
                            window.location.hash = '';
                        } else if (href.startsWith('#')) {
                            // Navigate to the hash
                            window.location.hash = href.replace('#', '');
                        }
                    });
                });
                
                removeExternalNavigation();
            } catch (error) {
                // Only show error if we're not in a loading state
                if (!mainContent.innerHTML.includes('Generating detail page')) {
                    const backLink = isDetailPage && parentIntentId 
                        ? `<a href="#${parentIntentId}" class="mt-4 inline-block font-semibold" style="color: var(--theme-primary, #3b82f6);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">← Back</a>`
                        : `<a href="#" class="mt-4 inline-block font-semibold" style="color: var(--theme-primary, #3b82f6);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">← Back to Home</a>`;
                    
                    mainContent.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h2 class="text-xl font-bold text-red-800 mb-2">Error Loading Page</h2>
                            <p class="text-red-600">${error.message}</p>
                            ${backLink}
                        </div>
                    `;
                }
            }
        }

        // Attach handlers for detail page links
        function attachDetailPageHandlers() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            
            const detailLinks = mainContent.querySelectorAll('a[href^="#"]');
            detailLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.includes('-detail-')) {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const detailPageId = href.replace('#', '');
                        
                        const parts = detailPageId.split('-detail-');
                        if (parts.length !== 2) return;
                        
                        const parentIntentId = parts[0];
                        const itemId = parts[1];
                        
                        // Show loader immediately and navigate
                        showDetailPageLoader(detailPageId, parentIntentId);
                        window.location.hash = detailPageId;
                    });
                }
            });
        }
        
        function showDetailPageLoader(detailPageId, parentIntentId) {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            
            mainContent.setAttribute('data-parent-intent', parentIntentId);
            
            mainContent.innerHTML = `
                <div class="flex items-center justify-center min-h-[400px]">
                    <div class="text-center">
                        <svg class="animate-spin h-12 w-12 mx-auto mb-4" style="color: var(--theme-primary, #3b82f6);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-lg font-semibold" style="color: var(--theme-text, #1f2937);">Generating detail page...</p>
                        <p class="text-sm text-gray-500 mt-2">Please wait while we create the page for you</p>
                    </div>
                </div>
            `;
            
            window.location.hash = detailPageId;
        }
        
        async function generateDetailPageFromLink(intentId, itemId) {
            if (isGenerating) return;
            isGenerating = true;
            
            try {
                // Backend will extract item data from fullSiteData
                const response = await fetch('http://localhost:3000/api/generate-detail-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        intentId,
                        itemId,
                        itemData: {}
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(errorText || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || 'Failed to generate detail page');
                }
                
                const data = await response.json();
                
                const currentHash = window.location.hash.replace('#', '');
                if (currentHash === data.detailPageId) {
                    // Force reload by triggering hash change
                    window.location.hash = '';
                    setTimeout(() => {
                        window.location.hash = data.detailPageId;
                    }, 10);
                } else {
                    window.location.hash = data.detailPageId;
                }
            } catch (error) {
                console.error('Error generating detail page:', error);
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    const parts = window.location.hash.replace('#', '').split('-detail-');
                    const parentIntentId = parts.length === 2 ? parts[0] : intentId;
                    
                    mainContent.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h2 class="text-xl font-bold text-red-800 mb-2">Error Generating Page</h2>
                            <p class="text-red-600">${error.message || 'Unknown error'}</p>
                            <a href="#${parentIntentId}" class="mt-4 inline-block font-semibold" style="color: var(--theme-primary, #3b82f6);" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                ← Back
                            </a>
                        </div>
                    `;
                }
            } finally {
                isGenerating = false;
            }
        }
        
        window.addEventListener('hashchange', handleHashChange);
        
        window.addEventListener('load', () => {
            checkExistingSession().then(() => {
                if (sessionId) {
                    handleHashChange();
                }
            });
        });
    </script>
</body>
</html>

